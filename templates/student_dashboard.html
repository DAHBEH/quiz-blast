<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <h1 class="navbar-brand">Quiz Blast! - Student</h1>
            <div class="navbar-menu">
                <span id="userDisplay" class="user-display"></span>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h2>- - -Welcome to Student Dashboard- - -</h2>
        </div>

        <div class="dashboard-content">
            <section class="dashboard-section">
                <h3>Search & Join Classroom</h3>
                <div class="search-bar">
                    <input type="text" id="searchClassroom" placeholder="Search classroom by name...">
                </div>
                <div id="searchResults" class="classrooms-list"></div>

                <div id="joinClassroomModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <span class="close" onclick="closeJoinModal()">&times;</span>
                        <h2>Join Classroom</h2>
                        <form id="joinForm">
                            <div class="form-group" id="passwordGroup">
                                <label for="joinPassword">Enter Classroom Password:</label>
                                <input type="password" id="joinPassword" placeholder="Enter password to join">
                            </div>
                            <button type="submit" class="btn btn-primary">Join</button>
                        </form>
                        <div id="joinError" class="error-message" style="display: none;"></div>
                    </div>
                </div>
            </section>

            <section class="dashboard-section">
                <h3>My Classrooms</h3>
                <div class="search-bar">
                    <input type="text" id="myClassroomSearch" placeholder="Search my classrooms...">
                </div>
                <div id="myClassroomsList" class="classrooms-list"></div>
            </section>
        </div>
    </div>

    <div id="classroomViewModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeClassroomView()">&times;</span>
            <h2 id="classroomViewTitle"></h2>

            <div class="modal-tabs">
                <button class="tab-button active" onclick="switchTab('quizzesView', this)">Quizzes</button>
                <button class="tab-button" onclick="switchTab('filesView', this)">Files</button>
                <button class="tab-button" onclick="switchTab('announcementsView', this)">Announcements</button>
            </div>


            <div id="quizzesViewTab" class="tab-content active">
                <div id="quizzesList"></div>
            </div>

            <div id="filesViewTab" class="tab-content">
                <div id="filesViewList"></div>
            </div>

            <div id="announcementsViewTab" class="tab-content">
                <h3>Class Announcements</h3>
                <div id="announcementsList"></div>
            </div>
        </div>
    </div>

    <div id="quizModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeQuizModalDirectly()">&times;</span>
            <h2 id="quizTitle"></h2>
            <p id="quizInstructions"></p>
            <p id="questionCounter"></p>

            <div id="questionDisplay"></div>

            <div id="timerDisplay" class="timer">
                <div class="bomb-container">
                    <svg class="bomb-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <!-- Bomb body -->
                        <ellipse cx="50" cy="65" rx="30" ry="35" fill="#333" />
                        <!-- Bomb top -->
                        <ellipse cx="50" cy="30" rx="30" ry="10" fill="#444" />
                        <!-- Highlight -->
                        <ellipse cx="40" cy="55" rx="10" ry="15" fill="#555" transform="rotate(-20 40 55)" />
                        <!-- Fuse base -->
                        <rect x="45" y="15" width="10" height="15" fill="#666" />
                        <!-- Fuse -->
                        <path class="fuse" d="M50 15 Q55 5 50 -5 Q45 5 50 15" fill="none" stroke="#8B4513"
                            stroke-width="3" />
                        <!-- Spark -->
                        <circle class="spark" cx="50" cy="-8" r="5" fill="#FF4500">
                            <animate attributeName="opacity" values="1;0.3;1" dur="0.3s" repeatCount="indefinite" />
                            <animate attributeName="r" values="5;8;5" dur="0.3s" repeatCount="indefinite" />
                        </circle>
                        <!-- Skull icon on bomb -->
                        <circle cx="50" cy="60" r="15" fill="#ddd" />
                        <ellipse cx="50" cy="75" rx="12" ry="8" fill="#ddd" />
                        <circle cx="45" cy="58" r="3" fill="#333" />
                        <circle cx="55" cy="58" r="3" fill="#333" />
                        <rect x="47" y="70" width="2" height="5" fill="#333" />
                        <rect x="51" y="70" width="2" height="5" fill="#333" />
                    </svg>
                    <div class="bomb-timer" id="bombTimer">50</div>
                </div>
                <div class="timer-text" id="timerText">Time Remaining</div>
            </div>

            <audio id="tickingSound" preload="auto">
                <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA="
                    type="audio/wav">
            </audio>

            <div id="deadlineWarning" class="deadline-warning" style="display: none;"></div>

            <div class="quiz-buttons">
                <button onclick="nextQuestion()" class="btn btn-secondary">Next</button>
                <button onclick="submitQuiz()" class="btn btn-primary">Submit Quiz</button>
            </div>
        </div>
    </div>

    <div id="resultsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeResultsModal()">&times;</span>
            <h2>Quiz Results</h2>
            <div id="resultsDisplay"></div>
            <button onclick="closeResultsModal()" class="btn btn-primary">Close</button>
        </div>
    </div>

    <script>
        let currentClassroomId = null;
        let currentQuizId = null;
        let currentQuestionIndex = 0;
        let quizQuestions = [];
        let quizAnswers = {};
        let questionTimer = null;
        let timeRemaining = 50;
        let quizSubmitted = false;

        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user-info');
                const user = await response.json();
                document.getElementById('userDisplay').textContent = `Welcome, ${user.username} (${user.section || 'No Section'})`;
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        async function searchClassrooms() {
            const searchQuery = document.getElementById('searchClassroom').value;

            if (searchQuery.length < 1) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`/api/classrooms/search?q=${encodeURIComponent(searchQuery)}`);
                const classrooms = await response.json();

                const searchResults = document.getElementById('searchResults');
                searchResults.innerHTML = '';

                classrooms.forEach(classroom => {
                    const classroomDiv = document.createElement('div');
                    classroomDiv.className = 'classroom-card';
                    classroomDiv.innerHTML = `
                        <h4>${classroom.name}</h4>
                        <p>${classroom.description || ''}</p>
                        <button onclick="openJoinModal(${classroom.id})" class="btn btn-primary">Join</button>
                    `;
                    searchResults.appendChild(classroomDiv);
                });
            } catch (error) {
                console.error('Error searching classrooms:', error);
            }
        }

        function openJoinModal(classroomId) {
            currentClassroomId = classroomId;
            document.getElementById('joinClassroomModal').style.display = 'block';
        }

        function closeJoinModal() {
            document.getElementById('joinClassroomModal').style.display = 'none';
        }

        document.getElementById('joinForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const password = document.getElementById('joinPassword').value;

            try {
                const response = await fetch(`/api/classrooms/${currentClassroomId}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    alert('Successfully joined classroom!');
                    closeJoinModal();
                    loadMyClassrooms();
                    document.getElementById('joinForm').reset();
                } else {
                    const data = await response.json();
                    document.getElementById('joinError').textContent = data.error;
                    document.getElementById('joinError').style.display = 'block';
                }
            } catch (error) {
                console.error('Error joining classroom:', error);
            }
        });

        async function loadMyClassrooms() {
            const searchQuery = document.getElementById('myClassroomSearch').value;
            try {
                const response = await fetch(`/api/classrooms?search=${encodeURIComponent(searchQuery)}`);
                const classrooms = await response.json();

                const classroomsList = document.getElementById('myClassroomsList');
                classroomsList.innerHTML = '';

                classrooms.forEach(classroom => {
                    const classroomDiv = document.createElement('div');
                    classroomDiv.className = 'classroom-card';
                    classroomDiv.innerHTML = `
                        <h4>${classroom.name}</h4>
                        <button onclick="openClassroomView(${classroom.id}, '${classroom.name}')" class="btn btn-primary">View</button>
                    `;
                    classroomsList.appendChild(classroomDiv);
                });
            } catch (error) {
                console.error('Error loading classrooms:', error);
            }
        }

        function openClassroomView(classroomId, classroomName) {
            currentClassroomId = classroomId;
            document.getElementById('classroomViewTitle').textContent = classroomName;
            document.getElementById('classroomViewModal').style.display = 'block';
            // Reset tabs - activate first tab
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById('quizzesViewTab').classList.add('active');
            document.querySelector('.modal-tabs .tab-button').classList.add('active');
            loadClassroomQuizzes();
            loadClassroomFiles();
            loadClassroomAnnouncements();
        }

        function closeClassroomView() {
            document.getElementById('classroomViewModal').style.display = 'none';
        }

        async function loadClassroomAnnouncements() {
            try {
                const response = await fetch(`/api/classrooms/${currentClassroomId}/announcements`);
                const announcements = await response.json();

                const announcementsList = document.getElementById('announcementsList');
                announcementsList.innerHTML = '';

                if (announcements.length === 0) {
                    announcementsList.innerHTML = '<p>No announcements for this class yet.</p>';
                    return;
                }

                announcements.forEach(announcement => {
                    const div = document.createElement('div');
                    div.className = 'announcement-card';
                    div.innerHTML = `
                        <h4>${announcement.title}</h4>
                        <p class="announcement-text">${announcement.content}</p>
                        <p class="announcement-meta">Posted: ${new Date(announcement.created_at).toLocaleString()}</p>
                    `;
                    announcementsList.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading announcements:', error);
            }
        }

        async function loadClassroomQuizzes() {
            try {
                const response = await fetch(`/api/classrooms/${currentClassroomId}/quizzes`);
                const quizzes = await response.json();

                const quizzesList = document.getElementById('quizzesList');
                quizzesList.innerHTML = '';

                quizzes.forEach(quiz => {
                    const quizDiv = document.createElement('div');
                    quizDiv.className = 'quiz-item';

                    let deadlineText = 'No deadline';
                    let deadlineClass = '';
                    let isPastDeadline = false;
                    if (quiz.deadline) {
                        const deadlineDate = new Date(quiz.deadline);
                        const now = new Date();
                        isPastDeadline = now > deadlineDate;
                        deadlineClass = isPastDeadline ? 'deadline-passed' : 'deadline-active';
                        deadlineText = `Deadline: ${deadlineDate.toLocaleString()}${isPastDeadline ? ' (PAST DUE)' : ''}`;
                    }

                    // Check if quiz is completed
                    let buttonHTML = '';
                    if (quiz.completed) {
                        buttonHTML = `<div class="completed-quiz">
                            <p class="completed-message">✓ You have already completed this quiz</p>
                            <p class="previous-score">Previous Score: ${quiz.previous_score}/${quiz.previous_total} (${quiz.previous_percentage.toFixed(2)}%)</p>
                        </div>`;
                    } else {
                        buttonHTML = `<button onclick="createSparkle(event); startQuiz(${quiz.id}, '${quiz.title.replace(/'/g, "\\'")}', ${quiz.questions ? quiz.questions.length : 0}, ${quiz.deadline ? "'" + quiz.deadline + "'" : 'null'})" class="btn btn-primary">Take Quiz</button>`;
                    }

                    quizDiv.innerHTML = `
                        <h5>${quiz.title}</h5>
                        <p>${quiz.instructions || ''}</p>
                        <p>Type: ${quiz.quiz_type}</p>
                        <p class="${deadlineClass}">${deadlineText}</p>
                        ${buttonHTML}
                    `;
                    quizzesList.appendChild(quizDiv);
                });
            } catch (error) {
                console.error('Error loading quizzes:', error);
            }
        }

        async function loadClassroomFiles() {
            try {
                const response = await fetch(`/api/classrooms/${currentClassroomId}/files`);
                const files = await response.json();

                const filesViewList = document.getElementById('filesViewList');
                filesViewList.innerHTML = '';

                files.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-item';

                    const deadlineText = file.deadline ? `Deadline: ${new Date(file.deadline).toLocaleString()}` : 'No deadline';

                    fileDiv.innerHTML = `
                        <h5>${file.custom_name}</h5>
                        <p>Instructions: ${file.instructions || 'None'}</p>
                        <p>${deadlineText}</p>
                        <a href="/api/files/${file.id}/download" class="btn btn-secondary">Download File</a>
                    `;
                    filesViewList.appendChild(fileDiv);
                });
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        async function startQuiz(quizId, quizTitle, questionCount, deadline) {
            currentQuizId = quizId;
            currentQuestionIndex = 0;
            quizAnswers = {};
            quizSubmitted = false;

            try {
                // First check if quiz is already completed
                const statusResponse = await fetch(`/api/classrooms/${currentClassroomId}/quizzes`);
                const quizzes = await statusResponse.json();
                const quizStatus = quizzes.find(q => q.id === quizId);

                if (quizStatus && quizStatus.completed) {
                    alert('You have already completed this quiz! Your previous score: ' + quizStatus.previous_score + '/' + quizStatus.previous_total + ' (' + quizStatus.previous_percentage.toFixed(2) + '%)');
                    return;
                }

                const response = await fetch(`/api/quizzes/${quizId}`);
                const quiz = await response.json();

                if (quiz.error) {
                    alert(quiz.error);
                    return;
                }

                quizQuestions = quiz.questions;

                document.getElementById('quizTitle').textContent = quizTitle;
                document.getElementById('quizInstructions').textContent = quiz.instructions || '';

                // Show deadline warning if past due
                const warningEl = document.getElementById('deadlineWarning');
                if (deadline) {
                    const deadlineDate = new Date(deadline);
                    const now = new Date();
                    if (now > deadlineDate) {
                        warningEl.textContent = '⚠️ This quiz is past its deadline! Your submission will be marked as late.';
                        warningEl.style.display = 'block';
                    } else {
                        warningEl.style.display = 'none';
                    }
                } else {
                    warningEl.style.display = 'none';
                }

                document.getElementById('quizModal').style.display = 'block';

                displayQuestion();
                startTimer();
            } catch (error) {
                console.error('Error loading quiz:', error);
            }
        }

        function displayQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                currentQuestionIndex = quizQuestions.length - 1;
            }

            const question = quizQuestions[currentQuestionIndex];
            document.getElementById('questionCounter').textContent = `Question ${currentQuestionIndex + 1} of ${quizQuestions.length}`;

            let questionHTML = `<div class="question">
                <p><strong>${question.question_text}</strong></p>`;

            if (question.question_type === 'multiple-choice') {
                questionHTML += `<div class="options">`;
                question.options.forEach(option => {
                    const isSelected = quizAnswers[question.id] === option ? 'checked' : '';
                    questionHTML += `
                        <label>
                            <input type="radio" name="answer_${question.id}" value="${option}" ${isSelected} onchange="saveAnswer(${question.id}, '${option}')">
                            ${option}
                        </label>
                    `;
                });
                questionHTML += `</div>`;
            } else if (question.question_type === 'true-false') {
                const trueSelected = quizAnswers[question.id] === 'true' ? 'checked' : '';
                const falseSelected = quizAnswers[question.id] === 'false' ? 'checked' : '';
                questionHTML += `
                    <label>
                        <input type="radio" name="answer_${question.id}" value="true" ${trueSelected} onchange="saveAnswer(${question.id}, 'true')">
                        True
                    </label>
                    <label>
                        <input type="radio" name="answer_${question.id}" value="false" ${falseSelected} onchange="saveAnswer(${question.id}, 'false')">
                        False
                    </label>
                `;
            }

            questionHTML += `</div>`;
            document.getElementById('questionDisplay').innerHTML = questionHTML;
        }

        function saveAnswer(questionId, answer) {
            quizAnswers[questionId] = answer;
        }

        function playTickSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 100;
                oscillator.type = 'sawtooth';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                startTimer();
            } else {
                // Last question answered, auto-submit
                submitQuiz();
            }
        }





        async function submitQuiz() {
            if (quizSubmitted) {
                alert('Quiz has already been submitted!');
                return;
            }

            if (!confirm('Are you sure you want to submit this quiz?')) return;

            const answers = {};
            quizQuestions.forEach(q => {
                answers[q.id] = quizAnswers[q.id] || '';
            });

            try {
                const response = await fetch(`/api/quizzes/${currentQuizId}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers })
                });

                const data = await response.json();

                if (response.ok) {
                    quizSubmitted = true;
                    closeQuizModal();
                    showResults(data);
                    loadClassroomQuizzes();
                } else {
                    alert(data.error || 'Error submitting quiz');
                }
            } catch (error) {
                console.error('Error submitting quiz:', error);
                alert('An error occurred while submitting the quiz');
            }
        }

        function showResults(result) {
            const resultsDisplay = document.getElementById('resultsDisplay');
            resultsDisplay.innerHTML = `
                <h3>Your Score: ${result.score}/${result.total}</h3>
                <h3>Percentage: ${result.percentage.toFixed(2)}%</h3>
            `;
            document.getElementById('resultsModal').style.display = 'block';
        }

        async function leaveQuiz() {
            if (quizSubmitted) {
                alert('Quiz has already been submitted!');
                return;
            }

            const answers = {};
            quizQuestions.forEach(q => {
                answers[q.id] = quizAnswers[q.id] || '';
            });

            try {
                const response = await fetch(`/api/quizzes/${currentQuizId}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers })
                });

                const data = await response.json();

                if (response.ok) {
                    quizSubmitted = true;
                    closeQuizModal();
                    showResults(data);
                    loadClassroomQuizzes();
                } else {
                    alert(data.error || 'Error submitting quiz');
                }
            } catch (error) {
                console.error('Error submitting quiz:', error);
                alert('An error occurred while submitting the quiz');
            }
        }

        function showResults(result) {
            const resultsDisplay = document.getElementById('resultsDisplay');
            resultsDisplay.innerHTML = `
                <h3>Your Score: ${result.score}/${result.total}</h3>
                <h3>Percentage: ${result.percentage.toFixed(2)}%</h3>
            `;
            document.getElementById('resultsModal').style.display = 'block';
        }


        function closeQuizModal() {
            document.getElementById('quizModal').style.display = 'none';
            if (questionTimer) clearInterval(questionTimer);
        }

        async function closeQuizModalDirectly() {
            // If quiz has been submitted, just close the modal
            if (quizSubmitted) {
                document.getElementById('quizModal').style.display = 'none';
                if (questionTimer) clearInterval(questionTimer);
                return;
            }

            // If quiz hasn't been submitted, ask for confirmation and submit
            if (!confirm('Are you sure you want to leave? Your answers will be automatically submitted.')) {
                return;
            }

            const answers = {};
            quizQuestions.forEach(q => {
                answers[q.id] = quizAnswers[q.id] || '';
            });

            try {
                const response = await fetch(`/api/quizzes/${currentQuizId}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers })
                });

                const data = await response.json();

                if (response.ok) {
                    quizSubmitted = true;
                    closeQuizModal();
                    showResults(data);
                    loadClassroomQuizzes();
                } else {
                    alert(data.error || 'Error submitting quiz');
                }
            } catch (error) {
                console.error('Error submitting quiz:', error);
                alert('An error occurred while submitting the quiz');
            }
        }

        function closeResultsModal() {
            document.getElementById('resultsModal').style.display = 'none';
        }

        function switchTab(tabName, clickedBtn) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName + 'Tab').classList.add('active');
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }
        }

        document.getElementById('searchClassroom').addEventListener('input', searchClassrooms);
        document.getElementById('myClassroomSearch').addEventListener('input', loadMyClassrooms);

        loadUserInfo();
        loadMyClassrooms();

        window.onclick = function (event) {
            const joinModal = document.getElementById('joinClassroomModal');
            const classroomModal = document.getElementById('classroomViewModal');
            const resultsModal = document.getElementById('resultsModal');

            if (event.target === joinModal) joinModal.style.display = 'none';
            if (event.target === classroomModal) classroomModal.style.display = 'none';
            // Quiz modal should NOT close on outside click - student must use Submit button
            if (event.target === resultsModal) resultsModal.style.display = 'none';
        };
    </script>
    <script>
        function playBeepSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 1200;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function startTimer() {
            timeRemaining = 15;
            if (questionTimer) clearInterval(questionTimer);

            document.getElementById('bombTimer').textContent = timeRemaining;
            document.getElementById('bombTimer').classList.remove('urgent');
            document.querySelector('.bomb-icon').classList.remove('explode');

            questionTimer = setInterval(() => {
                timeRemaining--;
                document.getElementById('bombTimer').textContent = timeRemaining;

                playTickSound();

                if (timeRemaining <= 10) {
                    playBeepSound();
                }

                if (timeRemaining <= 10) {
                    document.getElementById('bombTimer').classList.add('urgent');
                }

                if (timeRemaining <= 0) {
                    clearInterval(questionTimer);
                    document.querySelector('.bomb-icon').classList.add('explode');
                    playExplosionSound();
                    createExplosionEffect();
                    setTimeout(() => {
                        nextQuestion();
                    }, 1500);
                }
            }, 1000);
        }

        // ==================== COPY-PASTE PREVENTION ====================
        // Prevent copy, cut, and paste on quiz content
        document.getElementById('quizModal').addEventListener('copy', function (e) {
            e.preventDefault();
            showAntiCheatMessage('Copying is not allowed during the quiz!');
        });

        document.getElementById('quizModal').addEventListener('cut', function (e) {
            e.preventDefault();
            showAntiCheatMessage('Cutting is not allowed during the quiz!');
        });

        document.getElementById('quizModal').addEventListener('paste', function (e) {
            e.preventDefault();
            showAntiCheatMessage('Pasting is not allowed during the quiz!');
        });

        // Also prevent right-click context menu
        document.getElementById('quizModal').addEventListener('contextmenu', function (e) {
            e.preventDefault();
            showAntiCheatMessage('Copying is disabled during the quiz!');
        });

        // Prevent keyboard shortcuts for copy/paste
        document.addEventListener('keydown', function (e) {
            // Check if quiz modal is open
            if (document.getElementById('quizModal').style.display === 'block') {
                // Ctrl+C, Ctrl+X, Ctrl+V, Ctrl+U (view source), Ctrl+S (save)
                if (e.ctrlKey && e.shiftKey && (e.key === 'c' || e.key === 'x' || e.key === 'v' || e.key === 'u' || e.key === 's')) {
                    e.preventDefault();
                    showAntiCheatMessage('Copying and keyboard shorcuts is disabled during quiz!');
                }
            }
        });

        function showAntiCheatMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'anti-cheat-message';
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(220, 53, 69, 0.95);
                color: white;
                padding: 20px 40px;
                border-radius: 10px;
                font-size: 18px;
                font-weight: bold;
                z-index: 2000;
                animation: fadeIn 0.3s ease;
            `;
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 2000);
        }

        // Add animation for anti-cheat message
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
        `;
        document.head.appendChild(style);

        // ==================== SPARKLE EFFECTS ====================
        function createSparkle(event) {
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
            const x = event.clientX || event.pageX;
            const y = event.clientY || event.pageY;

            for (let i = 0; i < 12; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                const angle = (Math.PI * 2 * i) / 12;
                const distance = 30 + Math.random() * 40;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                sparkle.style.cssText = `
                    position: fixed;
                    left: ${x}px;
                    top: ${y}px;
                    width: ${4 + Math.random() * 6}px;
                    height: ${4 + Math.random() * 6}px;
                    border-radius: 50%;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    pointer-events: none;
                    z-index: 9999;
                    --tx: ${tx}px;
                    --ty: ${ty}px;
                    animation: sparkleAnim 0.8s ease-out forwards;
                `;
                document.body.appendChild(sparkle);
                setTimeout(() => sparkle.remove(), 900);
            }
        }

        // Add sparkle to all buttons on click
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('btn')) {
                createSparkle(e);
            }
        });

        // ==================== EXPLOSION EFFECTS ====================
        function playExplosionSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Create explosion noise
                const bufferSize = audioContext.sampleRate * 0.8;
                const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 2);
                }

                const noise = audioContext.createBufferSource();
                noise.buffer = buffer;

                const gainNode = audioContext.createGain();
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);

                const filter = audioContext.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(1000, audioContext.currentTime);
                filter.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.8);

                noise.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioContext.destination);

                noise.start(audioContext.currentTime);
                noise.stop(audioContext.currentTime + 0.8);

                // Add a low boom
                const osc = audioContext.createOscillator();
                const oscGain = audioContext.createGain();
                osc.frequency.setValueAtTime(150, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(30, audioContext.currentTime + 0.5);
                osc.type = 'sine';
                oscGain.gain.setValueAtTime(0.4, audioContext.currentTime);
                oscGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                osc.connect(oscGain);
                oscGain.connect(audioContext.destination);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function createExplosionEffect() {
            // Flash overlay
            const overlay = document.createElement('div');
            overlay.className = 'explosion-overlay';
            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), 1100);

            // Particles
            const colors = ['#FF4500', '#FF6347', '#FFD700', '#FF8C00', '#FF0000', '#FFA500', '#FFFF00'];
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                const angle = (Math.PI * 2 * i) / 30;
                const distance = 100 + Math.random() * 200;
                const ex = Math.cos(angle) * distance;
                const ey = Math.sin(angle) * distance;
                const size = 5 + Math.random() * 15;

                particle.className = 'explosion-particle';
                particle.style.cssText = `
                    position: fixed;
                    left: ${centerX}px;
                    top: ${centerY}px;
                    width: ${size}px;
                    height: ${size}px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    z-index: 9999;
                    --ex: ${ex}px;
                    --ey: ${ey}px;
                `;
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1300);
            }

            // Sparkles around the bomb area
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    const sx = centerX + (Math.random() - 0.5) * 300;
                    const sy = centerY + (Math.random() - 0.5) * 300;
                    sparkle.style.cssText = `
                        position: fixed;
                        left: ${sx}px;
                        top: ${sy}px;
                        width: ${3 + Math.random() * 5}px;
                        height: ${3 + Math.random() * 5}px;
                        border-radius: 50%;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        pointer-events: none;
                        z-index: 9999;
                        animation: sparkleAnim 0.6s ease-out forwards;
                        --tx: ${(Math.random() - 0.5) * 60}px;
                        --ty: ${(Math.random() - 0.5) * 60}px;
                    `;
                    document.body.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 700);
                }, i * 30);
            }
        }
    </script>
</body>

</html>