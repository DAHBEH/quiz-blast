<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <h1 class="navbar-brand">Quiz Blast! - Teacher</h1>
            <div class="navbar-menu">
                <span id="userDisplay" class="user-display"></span>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h2>- - -Welcome to Teacher Dashboard- - -</h2>
        </div>

        <div class="dashboard-content">
            <section class="dashboard-section">
                <h3>Create New Classroom</h3>
                <form id="createClassroomForm">
                    <div class="form-group">
                        <label for="classroomName">GRADE & SECTION:</label>
                        <input type="text" id="classroomName" required>
                    </div>
                    <div class="form-group">
                        <label for="classroomPassword">Classroom Password (Optional):</label>
                        <input type="password" id="classroomPassword" placeholder="Leave blank for no password">
                    </div>

                    <button type="submit" class="btn btn-primary">Create Classroom</button>
                </form>
                <div id="classroomError" class="error-message" style="display: none;"></div>
                <div id="classroomSuccess" class="success-message" style="display: none;"></div>
            </section>

            <section class="dashboard-section">
                <h3>My Classrooms</h3>
                <div class="search-bar">
                    <input type="text" id="classroomSearch" placeholder="Search classrooms...">
                </div>
                <div id="classroomsList" class="classrooms-list"></div>
            </section>
        </div>
    </div>

    <div id="classroomModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeClassroomModal()">&times;</span>
            <h2 id="classroomModalTitle"></h2>

            <div class="modal-tabs">
                <button class="tab-button active" onclick="switchTab('quizzes', this)">Create Quizzes</button>
                <button class="tab-button" onclick="switchTab('editQuiz', this)" id="editQuizTabBtn"
                    style="display:none;">Edit Quiz</button>
                <button class="tab-button" onclick="switchTab('files', this)">Upload Files</button>
                <button class="tab-button" onclick="switchTab('announcements', this)">Announcements</button>
                <button class="tab-button" onclick="switchTab('students', this)">Students</button>
                <button class="tab-button" onclick="switchTab('results', this)">Manage</button>
            </div>

            <div id="quizzesTab" class="tab-content active">
                <h3>Create New Quiz</h3>
                <form id="createQuizForm">
                    <div class="form-group">
                        <label for="quizTitle">Quiz Title:</label>
                        <input type="text" id="quizTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="quizInstructions">Instructions:</label>
                        <textarea id="quizInstructions"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="quizType">Quiz Type:</label>
                        <select id="quizType" required>
                            <option value="">Select type</option>
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="true-false">True/False</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quizDeadline">Deadline:</label>
                        <input type="datetime-local" id="quizDeadline">
                    </div>

                    <div id="questionsContainer"></div>
                    <button type="button" class="btn btn-secondary" onclick="addQuestion()">Add Question</button>
                    <button type="submit" class="btn btn-primary">Create Quiz</button>
                </form>
            </div>

            <div id="editQuizTab" class="tab-content">
                <h3>Edit Quiz</h3>
                <button type="button" class="btn btn-secondary" onclick="cancelEditQuiz()"
                    style="margin-bottom: 15px;">← Back to Create</button>
                <form id="editQuizForm">
                    <div class="form-group">
                        <label for="editQuizTitle">Quiz Title:</label>
                        <input type="text" id="editQuizTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="editQuizInstructions">Instructions:</label>
                        <textarea id="editQuizInstructions"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editQuizType">Quiz Type:</label>
                        <select id="editQuizType" required>
                            <option value="">Select type</option>
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="true-false">True/False</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editQuizDeadline">Deadline:</label>
                        <input type="datetime-local" id="editQuizDeadline">
                    </div>

                    <div id="editQuestionsContainer"></div>
                    <button type="button" class="btn btn-secondary" onclick="addEditQuestion()">Add Question</button>
                    <button type="submit" class="btn btn-primary">Update Quiz</button>
                </form>
            </div>

            <div id="filesTab" class="tab-content">
                <h3>Upload File</h3>
                <form id="uploadFileForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="fileInput">Choose File:</label>
                        <input type="file" id="fileInput" required>
                    </div>
                    <div class="form-group">
                        <label for="fileName">Title:</label>
                        <input type="text" id="fileName" required>
                    </div>

                    <div class="form-group">
                        <label for="fileInstructions">Instructions:</label>
                        <textarea id="fileInstructions"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="fileDeadline">Deadline:</label>
                        <input type="datetime-local" id="fileDeadline">
                    </div>
                    <button type="submit" class="btn btn-primary">Upload File</button>
                </form>
                <div id="filesList" class="files-list" style="margin-top: 20px;"></div>
            </div>

            <div id="announcementsTab" class="tab-content">
                <h3>Create Announcement</h3>
                <form id="createAnnouncementForm">
                    <div class="form-group">
                        <label for="announcementTitle">Title:</label>
                        <input type="text" id="announcementTitle" required
                            placeholder="e.g., Quiz Reminder, Class Update">
                    </div>
                    <div class="form-group">
                        <label for="announcementContent">Content:</label>
                        <textarea id="announcementContent" required placeholder="Enter your announcement here..."
                            style="min-height: 150px;"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Post Announcement</button>
                </form>
                <div id="announcementsList" class="announcements-list" style="margin-top: 20px;">
                    <h4>Posted Announcements</h4>
                    <div id="teacherAnnouncementsContainer"></div>
                </div>
            </div>

            <div id="studentsTab" class="tab-content">
                <h3>Joined Students</h3>
                <div id="studentsList" class="students-list"></div>
            </div>

            <div id="resultsTab" class="tab-content">
                <h3>Quiz Results & Analytics</h3>
                <div id="resultsList"></div>
            </div>
        </div>
    </div>

    <script>
        let currentClassroomId = null;
        let currentEditingQuizId = null;

        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user-info');
                const user = await response.json();
                document.getElementById('userDisplay').textContent = `Welcome, ${user.username}`;
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        async function loadClassrooms() {
            const searchQuery = document.getElementById('classroomSearch').value;
            try {
                const response = await fetch(`/api/classrooms?search=${encodeURIComponent(searchQuery)}`);
                const classrooms = await response.json();

                const classroomsList = document.getElementById('classroomsList');
                classroomsList.innerHTML = '';

                classrooms.forEach(classroom => {
                    const classroomDiv = document.createElement('div');
                    classroomDiv.className = 'classroom-card';
                    classroomDiv.innerHTML = `
                        <h4>${classroom.name}</h4>
                        <p>${classroom.description || ''}</p>
                        <p><strong>Password:</strong> ${classroom.password ? '****' : 'None'}</p>
                        <div class="classroom-actions">
                            <button onclick="openClassroom(${classroom.id}, '${classroom.name}')" class="btn btn-primary">Manage</button>
                            <button onclick="editClassroom(${classroom.id}, '${classroom.name}', '${classroom.description || ''}', '${classroom.password || ''}')" class="btn btn-secondary">Edit</button>
                            <button onclick="deleteClassroom(${classroom.id})" class="btn btn-danger">Delete</button>
                        </div>
                    `;
                    classroomsList.appendChild(classroomDiv);
                });
            } catch (error) {
                console.error('Error loading classrooms:', error);
            }
        }

        function closeClassroomModal() {
            document.getElementById('classroomModal').style.display = 'none';
        }

        function switchTab(tabName, clickedBtn) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Highlight the correct tab button
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            } else {
                // Find the button by matching tab name
                document.querySelectorAll('.tab-button').forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(tabName.toLowerCase()) ||
                        btn.getAttribute('onclick')?.includes("'" + tabName + "'")) {
                        btn.classList.add('active');
                    }
                });
            }

            // Load data for the selected tab
            if (tabName === 'students') {
                loadEnrolledStudents();
            } else if (tabName === 'announcements') {
                loadTeacherAnnouncements();
            } else if (tabName === 'quizzes') {
                loadClassroomQuizzes();
            } else if (tabName === 'results') {
                loadClassroomQuizzes();
            }
        }

        async function loadClassroomQuizzes() {
            try {
                const response = await fetch(`/api/classrooms/${currentClassroomId}/quizzes`);
                const quizzes = await response.json();

                const resultsList = document.getElementById('resultsList');
                resultsList.innerHTML = '<h4>Available Quizzes</h4>';

                quizzes.forEach(quiz => {
                    const quizDiv = document.createElement('div');
                    quizDiv.className = 'quiz-item';

                    let deadlineDisplay = 'No deadline';
                    let deadlineClass = '';
                    if (quiz.deadline) {
                        const dl = new Date(quiz.deadline);
                        const now = new Date();
                        deadlineClass = now > dl ? 'deadline-passed' : 'deadline-active';
                        deadlineDisplay = dl.toLocaleString() + (now > dl ? ' (EXPIRED)' : ' (ACTIVE)');
                    }

                    quizDiv.innerHTML = `
                        <h5>${quiz.title}</h5>
                        <p>Type: ${quiz.quiz_type}</p>
                        <p class="${deadlineClass}">Deadline: ${deadlineDisplay}</p>
                        <div class="quiz-actions">
                            <button onclick="viewQuizResults(${quiz.id})" class="btn btn-secondary">View Results</button>
                            <button onclick='editQuiz(${JSON.stringify(quiz).replace(/'/g, "&#39;")})' class="btn btn-secondary">Edit</button>
                            <button onclick="deleteQuiz(${quiz.id})" class="btn btn-danger">Delete</button>
                        </div>
                    `;
                    resultsList.appendChild(quizDiv);
                });
            } catch (error) {
                console.error('Error loading quizzes:', error);
            }
        }
        async function editQuiz(quiz) {
            currentEditingQuizId = quiz.id;
            document.getElementById('editQuizTitle').value = quiz.title;
            document.getElementById('editQuizInstructions').value = quiz.instructions || '';
            document.getElementById('editQuizType').value = quiz.quiz_type;

            // Format deadline for datetime-local input
            if (quiz.deadline) {
                const deadlineDate = new Date(quiz.deadline);
                const formatted = deadlineDate.toISOString().slice(0, 16);
                document.getElementById('editQuizDeadline').value = formatted;
            } else {
                document.getElementById('editQuizDeadline').value = '';
            }

            // Load questions
            try {
                const response = await fetch(`/api/quizzes/${quiz.id}`);
                const quizData = await response.json();
                const container = document.getElementById('editQuestionsContainer');
                container.innerHTML = '';

                quizData.questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question-form';
                    questionDiv.style.position = 'relative';
                    questionDiv.innerHTML = `
                        <button type="button" class="btn btn-danger" onclick="removeEditQuestion(this)" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; font-size: 12px;">Delete Question</button>
                        <h5>Question ${index + 1}</h5>
                        <input type="text" placeholder="Question text" class="question-text" value="${q.question_text.replace(/"/g, '&quot;')}" required>
                        ${quiz.quiz_type === 'multiple-choice' ? `
                            <input type="text" placeholder="Option 1" class="option" value="${(q.options[0] || '').replace(/"/g, '&quot;')}" required>
                            <input type="text" placeholder="Option 2" class="option" value="${(q.options[1] || '').replace(/"/g, '&quot;')}" required>
                            <input type="text" placeholder="Option 3" class="option" value="${(q.options[2] || '').replace(/"/g, '&quot;')}" required>
                            <input type="text" placeholder="Option 4" class="option" value="${(q.options[3] || '').replace(/"/g, '&quot;')}" required>
                        ` : ''}
                        <input type="text" placeholder="Correct answer" class="correct-answer" value="${q.correct_answer.replace(/"/g, '&quot;')}" required>
                    `;
                    container.appendChild(questionDiv);
                });

                // Show edit tab button and switch to it
                document.getElementById('editQuizTabBtn').style.display = 'block';
                document.querySelectorAll('#classroomModal .tab-content').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('#classroomModal .tab-button').forEach(b => b.classList.remove('active'));
                document.getElementById('editQuizTab').classList.add('active');
                document.getElementById('editQuizTabBtn').classList.add('active');
            } catch (error) {
                console.error('Error loading quiz questions:', error);
            }
        }

        function removeEditQuestion(btn) {
            if (confirm('Are you sure you want to delete this question?')) {
                btn.parentElement.remove();
                // Renumber questions
                const container = document.getElementById('editQuestionsContainer');
                Array.from(container.children).forEach((div, index) => {
                    div.querySelector('h5').textContent = `Question ${index + 1}`;
                });
            }
        }

        function addEditQuestion() {
            const container = document.getElementById('editQuestionsContainer');
            const quizType = document.getElementById('editQuizType').value;
            const questionIndex = container.children.length + 1;

            if (!quizType) {
                alert('Please select a quiz type first');
                return;
            }

            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-form';
            questionDiv.style.position = 'relative';
            questionDiv.innerHTML = `
                <button type="button" class="btn btn-danger" onclick="removeEditQuestion(this)" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; font-size: 12px;">Delete Question</button>
                <h5>Question ${questionIndex}</h5>
                <input type="text" placeholder="Question text" class="question-text" required>
                ${quizType === 'multiple-choice' ? `
                    <input type="text" placeholder="Option 1" class="option" required>
                    <input type="text" placeholder="Option 2" class="option" required>
                    <input type="text" placeholder="Option 3" class="option" required>
                    <input type="text" placeholder="Option 4" class="option" required>
                ` : ''}
                <input type="text" placeholder="Correct answer" class="correct-answer" required>
            `;
            container.appendChild(questionDiv);
        }

        function cancelEditQuiz() {
            currentEditingQuizId = null;
            document.getElementById('editQuizForm').reset();
            document.getElementById('editQuestionsContainer').innerHTML = '';
            document.getElementById('editQuizTabBtn').style.display = 'none';
            // Switch back to create tab
            document.querySelectorAll('#classroomModal .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#classroomModal .tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById('quizzesTab').classList.add('active');
            document.querySelector('#classroomModal .tab-button').classList.add('active');
        }
        async function deleteQuiz(quizId) {
            if (!confirm('Are you sure you want to delete this quiz? All results and answers will be permanently removed.')) return;

            try {
                const response = await fetch(`/api/quizzes/${quizId}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('Quiz deleted successfully');
                    loadClassroomQuizzes();
                }
            } catch (error) {
                console.error('Error deleting quiz:', error);
            }
        }

        async function updateDeadline(quizId) {
            const newDeadline = prompt('Enter new deadline (YYYY-MM-DDTHH:MM format):\nExample: 2026-03-15T23:59\nLeave empty to remove deadline:', '');

            if (newDeadline === null) return; // cancelled

            try {
                const response = await fetch(`/api/quizzes/${quizId}/deadline`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deadline: newDeadline || null })
                });

                const data = await response.json();
                if (response.ok) {
                    alert('Deadline updated successfully! Students who missed the old deadline can now answer the quiz.');
                    loadClassroomQuizzes();
                } else {
                    alert(data.error || 'Error updating deadline');
                }
            } catch (error) {
                console.error('Error updating deadline:', error);
            }
        }

        function editClassroom(id, name, description, password) {
            const newName = prompt('Enter new classroom name:', name);
            if (!newName) return;


            const newPassword = prompt('Enter new password (leave empty to keep current):', '');

            fetch(`/api/classrooms/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: newName,
                    description: newDesc,
                    password: newPassword
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Classroom updated successfully!');
                        loadClassrooms();
                    } else {
                        alert(data.error || 'Error updating classroom');
                    }
                })
                .catch(error => console.error('Error updating classroom:', error));
        }

        function deleteClassroom(id) {
            if (!confirm('Are you sure you want to delete this classroom? All students, quizzes, and results will be permanently removed.')) return;

            fetch(`/api/classrooms/${id}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Classroom deleted successfully!');
                        loadClassrooms();
                    } else {
                        alert(data.error || 'Error deleting classroom');
                    }
                })
                .catch(error => console.error('Error deleting classroom:', error));
        }

        async function loadEnrolledStudents() {
            try {
                console.log('Loading students for classroom:', currentClassroomId);
                const response = await fetch(`/api/classrooms/${currentClassroomId}/students`);
                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error loading students:', errorData);
                    document.getElementById('studentsList').innerHTML = `<p>Error loading students: ${errorData.error || 'Unknown error'}</p>`;
                    return;
                }

                const students = await response.json();
                console.log('Students loaded:', students);

                const studentsList = document.getElementById('studentsList');
                studentsList.innerHTML = '';

                if (students.length === 0) {
                    studentsList.innerHTML = '<p>No students joined yet.</p>';
                    return;
                }

                students.forEach(student => {
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'student-item';
                    studentDiv.innerHTML = `
                        <h5>${student.username}</h5>
                        <p>Email: ${student.email}</p>
                        <p>Section: ${student.section || 'N/A'}</p>
                        <p>Date Joined: ${new Date(student.enrolled_at).toLocaleString()}</p>
                        <button onclick="kickStudent(${student.id}, '${student.username}')" class="btn btn-danger">Kick Student</button>
                    `;
                    studentsList.appendChild(studentDiv);
                });
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('studentsList').innerHTML = '<p>Error loading students. Please try again.</p>';
            }
        }

        function kickStudent(studentId, studentName) {
            if (!confirm(`Are you sure you want to kick ${studentName} from this classroom?`)) return;

            console.log('Kicking student:', studentId, 'from classroom:', currentClassroomId);

            fetch(`/api/classrooms/${currentClassroomId}/students/${studentId}`, { method: 'DELETE' })
                .then(response => {
                    console.log('Kick response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Kick response data:', data);
                    if (data.success) {
                        alert('Student kicked successfully!');
                        loadEnrolledStudents();
                    } else {
                        alert(data.error || 'Error kicking student');
                    }
                })
                .catch(error => {
                    console.error('Error kicking student:', error);
                    alert('Error kicking student. Please try again.');
                });
        }

        async function loadClassroomFiles() {
            try {
                const response = await fetch(`/api/classrooms/${currentClassroomId}/files`);
                const files = await response.json();

                const filesList = document.getElementById('filesList');
                filesList.innerHTML = '<h4>Uploaded Files</h4>';

                files.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-item';
                    fileDiv.innerHTML = `
                        <h5>${file.custom_name}</h5>
                        <p>Deadline: ${file.deadline || 'No deadline'}</p>
                        <a href="/api/files/${file.id}/download" class="btn btn-secondary">Download</a>
                    `;
                    filesList.appendChild(fileDiv);
                });
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        function addQuestion() {
            const container = document.getElementById('questionsContainer');
            const quizType = document.getElementById('quizType').value;
            const questionIndex = container.children.length + 1;

            if (!quizType) {
                alert('Please select a quiz type first');
                return;
            }

            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-form';
            questionDiv.style.position = 'relative';
            questionDiv.innerHTML = `
                <button type="button" class="btn btn-danger" onclick="removeQuestion(this)" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; font-size: 12px;">Delete Question</button>
                <h5>Question ${questionIndex}</h5>
                <input type="text" placeholder="Question text" class="question-text" required>
                ${quizType === 'multiple-choice' ? `
                    <input type="text" placeholder="Option 1" class="option" required>
                    <input type="text" placeholder="Option 2" class="option" required>
                    <input type="text" placeholder="Option 3" class="option" required>
                    <input type="text" placeholder="Option 4" class="option" required>
                ` : ''}
                <input type="text" placeholder="Correct answer" class="correct-answer" required>
            `;
            container.appendChild(questionDiv);
        }

        function removeQuestion(btn) {
            if (confirm('Are you sure you want to delete this question?')) {
                btn.parentElement.remove();
                // Renumber questions
                const container = document.getElementById('questionsContainer');
                Array.from(container.children).forEach((div, index) => {
                    div.querySelector('h5').textContent = `Question ${index + 1}`;
                });
            }
        }

        document.getElementById('createClassroomForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('classroomName').value;
            const password = document.getElementById('classroomPassword').value;

            try {
                const response = await fetch('/api/classrooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, password })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('classroomSuccess').textContent = 'Classroom created successfully!';
                    document.getElementById('classroomSuccess').style.display = 'block';
                    document.getElementById('classroomError').style.display = 'none';
                    document.getElementById('createClassroomForm').reset();
                    loadClassrooms();
                    setTimeout(() => {
                        document.getElementById('classroomSuccess').style.display = 'none';
                    }, 3000);
                } else {
                    document.getElementById('classroomError').textContent = data.error || 'Error creating classroom';
                    document.getElementById('classroomError').style.display = 'block';
                }
            } catch (error) {
                console.error('Error creating classroom:', error);
                document.getElementById('classroomError').textContent = 'Network error. Please try again.';
                document.getElementById('classroomError').style.display = 'block';
            }
        });

        document.getElementById('createQuizForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('quizTitle').value;
            const instructions = document.getElementById('quizInstructions').value;
            const quiz_type = document.getElementById('quizType').value;
            const deadline = document.getElementById('quizDeadline').value;

            const questions = [];
            document.querySelectorAll('#questionsContainer .question-form').forEach(form => {
                const question_text = form.querySelector('.question-text').value;
                const options = Array.from(form.querySelectorAll('.option')).map(o => o.value).filter(o => o);
                const correct_answer = form.querySelector('.correct-answer').value;

                questions.push({
                    question: question_text,
                    type: quiz_type,
                    options: options,
                    correct_answer: correct_answer
                });
            });

            if (questions.length === 0) {
                alert('Please add at least one question');
                return;
            }

            try {
                const response = await fetch(`/api/classrooms/${currentClassroomId}/quizzes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title, instructions, quiz_type, deadline, questions
                    })
                });

                if (response.ok) {
                    alert('Quiz created successfully!');
                    document.getElementById('createQuizForm').reset();
                    document.getElementById('questionsContainer').innerHTML = '';
                    loadClassroomQuizzes();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error creating quiz');
                }
            } catch (error) {
                console.error('Error creating quiz:', error);
                alert('Error creating quiz');
            }
        });

        document.getElementById('editQuizForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentEditingQuizId) {
                alert('No quiz selected for editing');
                return;
            }

            const title = document.getElementById('editQuizTitle').value;
            const instructions = document.getElementById('editQuizInstructions').value;
            const quiz_type = document.getElementById('editQuizType').value;
            const deadline = document.getElementById('editQuizDeadline').value;

            const questions = [];
            document.querySelectorAll('#editQuestionsContainer .question-form').forEach(form => {
                const question_text = form.querySelector('.question-text').value;
                const options = Array.from(form.querySelectorAll('.option')).map(o => o.value).filter(o => o);
                const correct_answer = form.querySelector('.correct-answer').value;

                questions.push({
                    question: question_text,
                    type: quiz_type,
                    options: options,
                    correct_answer: correct_answer
                });
            });

            if (questions.length === 0) {
                alert('Please add at least one question');
                return;
            }

            try {
                const response = await fetch(`/api/quizzes/${currentEditingQuizId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title, instructions, quiz_type, deadline, questions
                    })
                });

                if (response.ok) {
                    alert('Quiz updated successfully!');
                    cancelEditQuiz();
                    loadClassroomQuizzes();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error updating quiz');
                }
            } catch (error) {
                console.error('Error updating quiz:', error);
                alert('Error updating quiz');
            }
        });

        document.getElementById('uploadFileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('file', document.getElementById('fileInput').files[0]);
            formData.append('custom_name', document.getElementById('fileName').value);
            formData.append('instructions', document.getElementById('fileInstructions').value);
            formData.append('deadline', document.getElementById('fileDeadline').value);

            try {
                const response = await fetch(`/api/classrooms/${currentClassroomId}/files`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert('File uploaded successfully!');
                    document.getElementById('uploadFileForm').reset();
                    loadClassroomFiles();
                }
            } catch (error) {
                console.error('Error uploading file:', error);
            }
        });

        document.getElementById('classroomSearch').addEventListener('input', loadClassrooms);

        // ==================== ANNOUNCEMENTS ====================
        document.getElementById('createAnnouncementForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;

            try {
                const response = await fetch(`/api/classrooms/${currentClassroomId}/announcements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content })
                });

                if (response.ok) {
                    alert('Announcement posted successfully!');
                    document.getElementById('createAnnouncementForm').reset();
                    loadTeacherAnnouncements();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error posting announcement');
                }
            } catch (error) {
                console.error('Error posting announcement:', error);
            }
        });

        async function loadTeacherAnnouncements() {
            try {
                const response = await fetch(`/api/classrooms/${currentClassroomId}/announcements`);
                const announcements = await response.json();

                const container = document.getElementById('teacherAnnouncementsContainer');
                container.innerHTML = '';

                if (announcements.length === 0) {
                    container.innerHTML = '<p>No announcements yet.</p>';
                    return;
                }

                announcements.forEach(announcement => {
                    const div = document.createElement('div');
                    div.className = 'announcement-item';
                    div.innerHTML = `
                        <h5>${announcement.title}</h5>
                        <p class="announcement-content">${announcement.content}</p>
                        <p class="announcement-meta">Posted by ${announcement.creator_name} on ${new Date(announcement.created_at).toLocaleString()}</p>
                        <button onclick="deleteAnnouncement(${announcement.id})" class="btn btn-danger">Delete</button>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading announcements:', error);
            }
        }

        async function deleteAnnouncement(announcementId) {
            if (!confirm('Are you sure you want to delete this announcement?')) return;

            try {
                const response = await fetch(`/api/classrooms/${currentClassroomId}/announcements/${announcementId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Announcement deleted!');
                    loadTeacherAnnouncements();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error deleting announcement');
                }
            } catch (error) {
                console.error('Error deleting announcement:', error);
            }
        }

        // ==================== QUIZ RESULTS & STATISTICS ====================
        async function viewQuizResults(quizId) {
            try {
                const response = await fetch(`/api/quizzes/${quizId}/results`);
                const results = await response.json();

                const resultsList = document.getElementById('resultsList');
                resultsList.innerHTML = '<h4>Quiz Results</h4>';

                if (Array.isArray(results)) {
                    const table = document.createElement('table');
                    table.className = 'results-table';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Section</th>
                                <th>Score</th>
                                <th>Percentage</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(r => `
                                <tr ${r.is_late ? 'style="background-color: #fff3cd;"' : ''}>
                                    <td>${r.student_name}</td>
                                    <td>${r.section || 'N/A'}</td>
                                    <td>${r.score}/${r.total}</td>
                                    <td>${r.percentage.toFixed(2)}%</td>
                                    <td>${r.is_late ? '<span style="color: #dc3545; font-weight: bold;"> LATE</span>' : '<span style="color: #28a745;">✓ On Time</span>'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    resultsList.appendChild(table);
                } else {
                    resultsList.innerHTML += '<p>No results available.</p>';
                }

                // Add button to view wrong answer statistics
                const statsBtn = document.createElement('button');
                statsBtn.className = 'btn btn-secondary';
                statsBtn.style.marginTop = '20px';
                statsBtn.textContent = 'View Wrong Answer Statistics';
                statsBtn.onclick = () => viewWrongAnswerStats(quizId);
                resultsList.appendChild(statsBtn);

                // Add button to view student progress
                const progressBtn = document.createElement('button');
                progressBtn.className = 'btn btn-secondary';
                progressBtn.style.marginTop = '10px';
                progressBtn.style.marginLeft = '10px';
                progressBtn.textContent = 'View Student Progress';
                progressBtn.onclick = () => viewStudentProgress(quizId);
                resultsList.appendChild(progressBtn);
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        async function viewWrongAnswerStats(quizId) {
            try {
                const response = await fetch(`/api/quizzes/${quizId}/wrong-answer-stats`);
                const data = await response.json();

                const resultsList = document.getElementById('resultsList');
                resultsList.innerHTML = `<h4>Wrong Answer Statistics</h4>`;
                resultsList.innerHTML += `<p><strong>Total Students Who Took Quiz:</strong> ${data.total_students}</p>`;

                if (data.stats && data.stats.length > 0) {
                    const statsContainer = document.createElement('div');
                    statsContainer.className = 'stats-container';

                    data.stats.forEach((stat, index) => {
                        const statDiv = document.createElement('div');
                        statDiv.className = 'stat-item';
                        statDiv.style.borderLeft = stat.wrong_percentage > 50 ? '4px solid #dc3545' : '4px solid #28a745';

                        statDiv.innerHTML = `
                            <div class="stat-header">
                                <span class="stat-number">#${index + 1}</span>
                                <span class="stat-percentage">${stat.wrong_percentage}% Wrong</span>
                            </div>
                            <p class="stat-question"><strong>Q:</strong> ${stat.question_text}</p>
                            <p class="stat-correct"><strong>Correct Answer:</strong> ${stat.correct_answer}</p>
                            <p class="stat-wrong-count">Wrong Answers: ${stat.wrong_count} out of ${stat.total_answers}</p>
                            ${stat.most_common_wrong_answer ? `
                                <p class="stat-common-wrong"><strong>Most Common Wrong:</strong> ${stat.most_common_wrong_answer}</p>
                            ` : ''}
                        `;
                        statsContainer.appendChild(statDiv);
                    });

                    resultsList.appendChild(statsContainer);
                } else {
                    resultsList.innerHTML += '<p>No statistics available yet.</p>';
                }

                // Add back button
                const backBtn = document.createElement('button');
                backBtn.className = 'btn btn-secondary';
                backBtn.style.marginTop = '20px';
                backBtn.textContent = 'Back to Results';
                backBtn.onclick = () => {
                    const quizId = currentClassroomId; // This will be reset when viewing results
                    // Reload quizzes to get back to quiz list
                    loadClassroomQuizzes();
                };
                resultsList.appendChild(backBtn);
            } catch (error) {
                console.error('Error loading wrong answer stats:', error);
            }
        }

        async function viewStudentProgress(quizId) {
            try {
                const response = await fetch(`/api/quizzes/${quizId}/student-progress`);
                const students = await response.json();

                const resultsList = document.getElementById('resultsList');
                resultsList.innerHTML = '<h4>Student Progress</h4>';

                if (students.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'results-table progress-table';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Section</th>
                                <th>Status</th>
                                <th>Score</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map(s => `
                                <tr class="${s.score === null ? 'not-taken' : ''}">
                                    <td>${s.username}</td>
                                    <td>${s.section || 'N/A'}</td>
                                    <td>${s.score !== null ? 'Completed' : 'Not Taken'}</td>
                                    <td>${s.score !== null ? s.score + '/' + s.total_questions : '-'}</td>
                                    <td>${s.percentage !== null ? s.percentage.toFixed(2) + '%' : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    resultsList.appendChild(table);

                    // Summary
                    const completed = students.filter(s => s.score !== null).length;
                    const notTaken = students.filter(s => s.score === null).length;

                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'progress-summary';
                    summaryDiv.innerHTML = `
                        <p><strong>Summary:</strong></p>
                        <p>Completed: ${completed} students</p>
                        <p>Not Taken: ${notTaken} students</p>
                    `;
                    resultsList.appendChild(summaryDiv);
                } else {
                    resultsList.innerHTML += '<p>No students enrolled.</p>';
                }

                // Add back button
                const backBtn = document.createElement('button');
                backBtn.className = 'btn btn-secondary';
                backBtn.style.marginTop = '20px';
                backBtn.textContent = 'Back to Results';
                backBtn.onclick = () => loadClassroomQuizzes();
                resultsList.appendChild(backBtn);
            } catch (error) {
                console.error('Error loading student progress:', error);
            }
        }

        function openClassroom(classroomId, classroomName) {
            currentClassroomId = classroomId;
            document.getElementById('classroomModalTitle').textContent = `Manage: ${classroomName}`;
            document.getElementById('classroomModal').style.display = 'block';
            // Reset tabs
            document.querySelectorAll('#classroomModal .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#classroomModal .tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById('quizzesTab').classList.add('active');
            document.querySelector('#classroomModal .tab-button').classList.add('active');
            loadClassroomQuizzes();
            loadClassroomFiles();
            loadTeacherAnnouncements();
        }

        loadUserInfo();
        loadClassrooms();


        window.onclick = function (event) {
            const modal = document.getElementById('classroomModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // ==================== SPARKLE EFFECTS FOR ALL BUTTONS ====================
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('btn') || e.target.classList.contains('tab-button')) {
                const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
                const x = e.clientX || e.pageX;
                const y = e.clientY || e.pageY;

                for (let i = 0; i < 12; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    const angle = (Math.PI * 2 * i) / 12;
                    const distance = 30 + Math.random() * 40;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance;
                    sparkle.style.cssText = `
                        position: fixed;
                        left: ${x}px;
                        top: ${y}px;
                        width: ${4 + Math.random() * 6}px;
                        height: ${4 + Math.random() * 6}px;
                        border-radius: 50%;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        pointer-events: none;
                        z-index: 9999;
                        --tx: ${tx}px;
                        --ty: ${ty}px;
                        animation: sparkleAnim 0.8s ease-out forwards;
                    `;
                    document.body.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 900);
                }
            }
        });
    </script>
</body>

</html>